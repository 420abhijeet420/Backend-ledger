const express = require("express")
const userModel = require("../models/user.model")
const jwt = require("jsonwebtoken")


async function userRegisterController(req,res){
    const {email,password,name}= req.body
    const doesExist= await userModel.findOne({
        email:email
    })

    if(doesExist){
        return res.status(422).json({
            message:"User already exists with email",
            status:"failed"
        })
    }

    const user = await userModel.create({email,password,name})
/**
 * JWT (JSON Web Token)
 * ----------------------
 * Used for authentication.
 * After user logs in or registers, we generate a token.
 * This token proves the user is authenticated.
 *
 * jwt is imported from the "jsonwebtoken" package:
 * const jwt = require("jsonwebtoken")
 *
 * jwt.sign(payload, secret, options)
 *
 * PARAMETERS EXPLAINED:
 *
 * 1️⃣ payload:
 *    - The data we want to store inside the token.
 *    - Here we store: { userId: user._id }
 *    - user._id is automatically generated by MongoDB.
 *    - We store only minimal data (never store password or sensitive info).
 *
 * 2️⃣ secret:
 *    - process.env.JWT_SECRET
 *    - A private key used to sign the token.
 *    - Must be stored in .env file.
 *    - Used later to verify the token.
 *
 * 3️⃣ options:
 *    - expiresIn: "3d"
 *    - Token will expire after 3 days.
 *    - Prevents permanent authentication.
 *
 * HOW JWT WORKS:
 * --------------
 * Token structure:
 *    Header.Payload.Signature
 *
 * - Header: Algorithm info (e.g., HS256)
 * - Payload: { userId: ... }
 * - Signature: Created using secret key
 *
 * When user sends token back:
 * jwt.verify(token, process.env.JWT_SECRET)
 *
 * If:
 *   ✔ signature is valid
 *   ✔ token not expired
 * Then:
 *   → user is authenticated
 *
 * SECURITY NOTE:
 * --------------
 * JWT payload is NOT encrypted.
 * It is only Base64 encoded.
 * Anyone can decode it.
 * Never store sensitive data inside payload.
 */
    const token = jwt.sign({userId: user._id}, process.env.JWT_SECRET,{expiresIn: "3d"})
/**
 * npm i cookie-parser -> in app.js ->import cookie-parser & app.use(cookieParser)
 */
    res.cookie("token",token)
    res.status(201).json({
        user:{
            _id: user._id,
            name: user.name,
            email: user.email
        },
        token
    })

} 



async function userLoginController(req,res) {
    const {email,password} = req.body
    const user = await userModel.findOne({
        email:email
    }).select("+password")

    if(!user){
        return res.status(401).json({
            message: "Email or Password is invalid"
        })
    }
    const isValidPassword = await user.comparePassword(password)

    if(!isValidPassword){
        return res.status(401).json({
            message:"Email or Password is invalid"
        })
    }
    const token = jwt.sign({userId: user._id}, process.env.JWT_SECRET,{expiresIn:"3d"})
    res.cookie("token", token)

    return res.json({
        user:{
            _id: user._id,
            name: user.name,
            email:user.email
        },
        token
    })
    
}


   
module.exports ={
    userRegisterController,
    userLoginController
}